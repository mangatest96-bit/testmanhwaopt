<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Manhwa Script</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f8f9fa; margin: 20px; }
        h1 { text-align: center; color: #2c3e50; }
        .admin-panel { display: none; background: #fff; padding: 15px; border: 2px solid #3498db; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        .admin-mode .admin-panel { display: block; }
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        th, td { padding: 15px; text-align: center; border-bottom: 1px solid #eee; }
        th { background: #34495e; color: white; }
        .btn-edit { display: none; cursor: pointer; color: #3498db; margin-right: 10px; }
        .admin-mode .btn-edit { display: inline-block; }
        .link-style { background: #e74c3c; color: white; padding: 6px 12px; border-radius: 5px; text-decoration: none; font-weight: bold; }
        .tag { background: #eee; padding: 2px 8px; border-radius: 4px; margin: 2px; font-size: 0.8em; }
        button { cursor: pointer; padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body class="guest-mode">

    <h1>Manhwa Script</h1>

    <div id="adminPanel" class="admin-panel">
        <strong>أهلاً بك يا مسؤول! ✅</strong>
        <button onclick="addNewManhwa()" style="margin-right: 20px;">إضافة مانهوا جديدة +</button>
        <button onclick="logout()" style="background: #c0392b;">خروج</button>
    </div>

    <table id="manhwaTable">
        <thead>
            <tr>
                <th>الاسم</th>
                <th>ID</th>
                <th>الرابط</th>
                <th>Access (صلاحيات)</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <script>
        // --- إعدادات المستودع الخاصة بك ---
        const REPO_OWNER = 'mangatest96-bit';
        const REPO_NAME = 'testmanhwaopt';

        // التأكد من حالة المسؤول عند التحميل
        if (localStorage.getItem('my_gh_token')) {
            document.body.classList.add('admin-mode');
        }

        // اختصار لوحة المفاتيح Ctrl + F + T لتسجيل الدخول
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key.toLowerCase() === 'f') {
                e.preventDefault();
                const pass = prompt("كلمة السر:");
                if (pass === "yassirahmidmh") {
                    const token = prompt("أدخل التوكن الخاص بك (مرة واحدة فقط):");
                    if (token) {
                        localStorage.setItem('my_gh_token', token);
                        location.reload();
                    }
                }
            }
        });

        function logout() {
            localStorage.removeItem('my_gh_token');
            location.reload();
        }

        // جلب البيانات من GitHub Issues
        async function loadManhwas() {
            const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues?state=open`);
            const issues = await res.json();
            const tbody = document.getElementById('tableBody');

            issues.forEach(issue => {
                let data;
                try { data = JSON.parse(issue.body); } catch(e) { return; }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${data.name}</td>
                    <td>${data.id} <i class="fas fa-edit btn-edit" onclick="alert('خاصية تعديل Issue رقم ${issue.number} قادمة')"></i></td>
                    <td><a href="${data.url}" target="_blank" class="link-style">الرابط</a> <i class="fas fa-edit btn-edit"></i></td>
                    <td>
                        ${data.access.map(n => `<span class="tag">${n}</span>`).join('')}
                        <i class="fas fa-plus-circle btn-edit" style="color:green"></i>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // إضافة مانهوا جديدة وحفظها في GitHub
        async function addNewManhwa() {
            const token = localStorage.getItem('my_gh_token');
            const name = prompt("اسم المانهوا:");
            if (!name) return;
            const id = prompt("المعرف (ID):");
            const url = prompt("الرابط:");
            const access = prompt("الأرقام التسلسلية (افصل بينها بفاصلة):").split(',');

            const content = { name, id, url, access };

            const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues`, {
                method: 'POST',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: `Manhwa: ${name}`,
                    body: JSON.stringify(content)
                })
            });

            if (res.ok) {
                alert("تم الحفظ بنجاح في GitHub!");
                location.reload();
            } else {
                alert("حدث خطأ! تأكد من صلاحية التوكن.");
            }
        }

        loadManhwas();
    </script>
</body>
</html>